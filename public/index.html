<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🎉 Random Giveaway Picker</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="container">
    <h1>🎁 Discord Giveaway Tracker</h1>

    <p id="statusText" class="status">🔄 Memuat status...</p>
    <div id="countdown" class="countdown">⏳ Menghitung waktu...</div>

    <p>👤 Login sebagai: <strong id="userDisplay"></strong></p>
    <button onclick="logout()">🔓 Logout</button>

    <form id="giveawayForm" class="form">
      <input type="number" id="number" placeholder="🎲 Angka (1–1000)" min="1" max="1000" required />
      <button type="submit">🚀 Kirim</button>
      <div id="formStatus" class="status-message"></div>
    </form>

    <div id="winner" class="winner">⏳ Memuat pemenang...</div>

    <h3>📋 Semua Peserta</h3>
    <div id="participants" class="participant-list">Memuat peserta...</div>
  </div>

<script>
  // === Proteksi login
  const user = JSON.parse(localStorage.getItem("giveawayUser"));
  if (!user || !user.username) {
    window.location.href = "/login.html";
  }

  document.getElementById("userDisplay").textContent = user.username;

  function logout() {
    localStorage.removeItem("giveawayUser");
    window.location.href = "/login.html";
  }

  const form = document.getElementById("giveawayForm");
  const numberInput = document.getElementById("number");
  const statusEl = document.getElementById("formStatus");
  const winnerEl = document.getElementById("winner");
  const partList = document.getElementById("participants");

  let startTime = null;
  let endTime = null;

  // === Form Submit
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const number = parseInt(numberInput.value);

    if (isNaN(number) || number < 1 || number > 1000) {
      statusEl.textContent = "❌ Masukkan angka antara 1–1000";
      return;
    }

    const now = new Date();
    if (!startTime || !endTime || now < startTime || now > endTime) {
      statusEl.textContent = "⛔ Giveaway belum aktif atau sudah berakhir!";
      return;
    }

    statusEl.textContent = "🔄 Mengirim angka...";

    try {
      const res = await fetch("/api/data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "submit",
          username: user.username,
          message: number
        })
      });

      const text = await res.text();
      if (text === "OK") {
        statusEl.textContent = "✅ Berhasil ikut giveaway!";
        numberInput.value = "";
        fetchData();
      } else {
        statusEl.textContent = "⚠️ " + text;
      }
    } catch (err) {
      statusEl.textContent = "❌ Gagal kirim: " + err.message;
    }
  });

  // === Fetch Peserta, Pemenang, dan Waktu
  async function fetchData() {
    try {
      const res = await fetch("/api/data");
      const data = await res.json();

      const statusText = document.getElementById("statusText");

      // Simpan start & end time
      if (data.startTime) startTime = new Date(data.startTime);
      if (data.endTime) endTime = new Date(data.endTime);

      // Status server
      if (data.status === "closed") {
        statusText.textContent = "⛔ Giveaway telah ditutup.";
        form.style.display = "none";
      } else if (data.status === "upcoming") {
        statusText.textContent = "⏳ Giveaway belum dimulai.";
        form.style.display = "none";
      } else if (data.status === "open") {
        statusText.textContent = "🎉 Giveaway sedang berlangsung!";
        form.style.display = "block";
      } else {
        statusText.textContent = "❓ Status tidak diketahui";
        form.style.display = "none";
      }

      // Pemenang
      if (data.winner) {
        winnerEl.textContent = `🏆 Pemenang: ${data.winner.username} (${data.winner.number})`;
      } else {
        winnerEl.textContent = "Belum ada pemenang.";
      }

      // Peserta
      if (Array.isArray(data.participants)) {
        partList.innerHTML = data.participants.map(p =>
          `<div class="participant">👤 ${p.username} — 🎯 ${p.number}</div>`
        ).join('');
      } else {
        partList.textContent = "Belum ada peserta.";
      }

    } catch (err) {
      console.error("❌ Fetch error:", err.message);
      winnerEl.textContent = "❌ Gagal memuat data";
      partList.textContent = "🚫 Tidak bisa mengambil data";
    }
  }

  // === Countdown Timer
  function updateCountdown() {
    const now = new Date();
    const countdownEl = document.getElementById("countdown");

    if (!startTime || !endTime) {
      countdownEl.textContent = "⏳ Memuat waktu giveaway...";
      return;
    }

    if (now < startTime) {
      const diff = startTime - now;
      countdownEl.textContent = `🕒 Dimulai dalam: ${formatTime(diff)}`;
      form.style.display = "none";
    } else if (now >= startTime && now <= endTime) {
      const diff = endTime - now;
      countdownEl.textContent = `⏳ Tersisa: ${formatTime(diff)}`;
      form.style.display = "block";
    } else {
      countdownEl.textContent = "⛔ Giveaway sudah ditutup!";
      form.style.display = "none";
    }
  }

  function formatTime(diff) {
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((diff / 1000 / 60) % 60);
    const seconds = Math.floor((diff / 1000) % 60);

    const parts = [];
    if (days > 0) parts.push(`${days}d`);
    if (hours > 0 || days > 0) parts.push(`${hours}h`);
    if (minutes > 0 || hours > 0 || days > 0) parts.push(`${minutes}m`);
    parts.push(`${seconds}s`);

    return parts.join(" ");
  }

  // === Init
  fetchData();
  setInterval(fetchData, 5000);
  setInterval(updateCountdown, 1000);
</script>

</body>
</html>
